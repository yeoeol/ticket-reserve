services:
  registry:
    image: ${DOCKERHUB_USERNAME}/tr-registry:latest
    container_name: tr-registry
    ports:
      - "8761:8761"
    environment:
      - JAVA_OPTS=-Xms128m -Xmx256m
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8761/actuator/health" ]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - tr-network

  gateway-platform:
    image: ${DOCKERHUB_USERNAME}/tr-gateway:latest
    container_name: tr-gateway-platform
    env_file:
      - ./.env
    environment:
      - JAVA_OPTS=-Xms128m -Xmx256m
    ports:
      - "80:80"
    depends_on:
      registry:
        condition: service_started
    networks:
      - tr-network

  user-service:
    image: ${DOCKERHUB_USERNAME}/tr-user:latest
    container_name: tr-user-service
    env_file:
      - ./.env
    environment:
      - JAVA_OPTS=-Xms128m -Xmx256m
    ports:
      - "30000:30000"
    depends_on:
      registry:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:30000/actuator/health" ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 120s
    networks:
      - tr-network

  busking-service:
    image: ${DOCKERHUB_USERNAME}/tr-busking:latest
    container_name: tr-busking-service
    env_file:
      - ./.env
    environment:
      - JAVA_OPTS=-Xms128m -Xmx256m
    ports:
      - "30001:30001"
    depends_on:
      user-service:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:30001/actuator/health" ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 120s
    networks:
      - tr-network

  image-service:
    image: ${DOCKERHUB_USERNAME}/tr-image:latest
    container_name: tr-image-service
    env_file:
      - ./.env
    environment:
      - JAVA_OPTS=-Xms128m -Xmx256m
    ports:
      - "33333:33333"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:33333/actuator/health" ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 120s
    networks:
      - tr-network

  notification-service:
    image: ${DOCKERHUB_USERNAME}/tr-notification:latest
    container_name: tr-notification-service
    env_file:
      - ./.env
    environment:
      - JAVA_OPTS=-Xms128m -Xmx256m
    ports:
      - "34444:34444"
    depends_on:
      image-service:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:34444/actuator/health" ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 120s
    networks:
      - tr-network

  subscription-service:
    image: ${DOCKERHUB_USERNAME}/tr-subscription:latest
    container_name: tr-subscription-service
    env_file:
      - ./.env
    environment:
      - JAVA_OPTS=-Xms128m -Xmx256m
    ports:
      - "35555:35555"
    depends_on:
      notification-service:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:35555/actuator/health" ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 150s
    networks:
      - tr-network

  hot-busking-service:
    image: ${DOCKERHUB_USERNAME}/tr-hot-busking:latest
    container_name: tr-hot-busking-service
    env_file:
      - ./.env
    environment:
      - JAVA_OPTS=-Xms128m -Xmx256m
    ports:
      - "36666:36666"
    depends_on:
      subscription-service:
        condition: service_started
    networks:
      - tr-network

networks:
  tr-network:
    driver: bridge